<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic POS System (Offline Inventory & Sales)</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.71/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.71/vfs_fonts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Base and Typography */
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #e9ebee;
            /* Light Gray Background */
            color: #333;
        }

        /* Main Layout - Modified for Single Page Application (SPA) view toggle */
        .main-container {
            display: block;
            /* Change from grid to block for single-page view control */
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background-color: transparent;
        }

        /* Styling for Left and Right Panels */
        .left-panel,
        .right-panel {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            /* Soft shadow */
        }

        .right-panel {
            min-height: 80vh;
            /* Ensure sales area is tall */
            display: flex;
            flex-direction: column;
        }

        h1,
        h2 {
            color: #007bff;
            /* Primary Blue */
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        /* Status Messages */
        .status-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .info {
            background-color: #e6f7ff;
            color: #007bff;
            border: 1px solid #91d5ff;
        }

        .success {
            background-color: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .error {
            background-color: #fff1f0;
            color: #f5222d;
            border: 1px solid #ffa39e;
        }

        .status-active {
            background-color: #52c41a;
            color: white;
            padding: 8px;
            border-radius: 4px;
        }

        .status-inactive {
            background-color: #f5222d;
            color: white;
            padding: 8px;
            border-radius: 4px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }


        /* Input/Button Styling */
        input[type="text"],
        input[type="number"],
        input[type="file"],
        select,
        input[type="date"] {
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            width: calc(100% - 22px);
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus,
        select:focus {
            border-color: #40a9ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s, transform 0.1s;
            font-weight: 500;
        }

        button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .delete-btn {
            background-color: #faad14;
        }

        /* Warning color for delete */
        .delete-btn:hover {
            background-color: #d49211;
        }

        /* Specific Button Colors */
        .btn-success {
            background-color: #52c41a;
        }

        .btn-success:hover {
            background-color: #389e08;
        }

        .btn-warning {
            background-color: #faad14;
        }

        .btn-warning:hover {
            background-color: #d49211;
        }

        .btn-info {
            background-color: #1890ff;
        }

        .btn-info:hover {
            background-color: #096dd9;
        }

        /* Action Card for Left Panel */
        .action-card {
            border: 1px solid #e9ecef;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        /* Sales Panel Specifics */
        #search-container {
            position: relative;
            margin-bottom: 15px;
        }

        #search-input {
            width: 100%;
            font-size: 1.1em;
            padding: 12px;
        }

        /* Suggestions Dropdown */
        #suggestions {
            position: absolute;
            z-index: 10;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            display: none;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover,
        .suggestion-item.active {
            background-color: #e6f7ff;
        }

        .barcode-sku {
            font-size: 0.8em;
            color: #8c8c8c;
            display: flex;
            gap: 10px;
        }

        .stock-info {
            font-weight: bold;
            color: #faad14;
        }

        /* Sales Table Styling */
        .sales-table-wrapper {
            flex-grow: 1;
            /* Table takes up remaining vertical space */
            overflow-y: auto;
            /* Scroll for many items */
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        th {
            background-color: #f8f9fa;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        /* Grand Total Footer */
        .total-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #d4e8ff;
        }

        .total-footer strong {
            font-size: 1.5em;
            color: #007bff;
        }

        #grandTotal {
            font-size: 1.8em;
            color: #ff4d4f;
            font-weight: bold;
        }

        .payment-button-container {
            text-align: right;
            margin-top: 10px;
        }


        /* Modals - Keep styling similar for consistency */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Payment Modal Specifics */
        #payableAmount,
        #receivedAmount,
        #changeAmount {
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: bold;
        }

        #changeAmount {
            font-size: 1.4em;
        }

        .payment-line {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        /* Responsive Adjustments */
        @media (max-width: 1024px) {
            /* .main-container { grid-template-columns: 1fr; } - Removed grid, handled by new view toggler */

            .left-panel,
            .right-panel {
                min-height: auto;
            }

            .payment-line {
                grid-template-columns: 1fr 1fr;
            }

            .remove-payment-btn {
                grid-column: 3 / 4;
            }
        }

        /* Hide sections not critical for day-to-day sales by default */
        #history-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .hidden-details {
            display: none;
            padding: 10px 0;
            border-top: 1px dashed #ccc;
        }
    </style>
</head>

<body>

    <body>

        <div id="loginModal"
            style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
            <div
                style="background-color: white; padding: 30px; border-radius: 10px; width: 300px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <h2>‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <input type="text" id="usernameInput" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ" required
                    style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px;">
                <input type="password" id="passwordInput" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°" required
                    style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px;">
                <button id="loginButton"
                    style="width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">‡¶≤‡¶ó‡¶á‡¶®</button>
                <p id="loginMessage" style="color: red; margin-top: 10px;"></p>
            </div>
        </div>
        <div id="mainContainer" style="display: none;">
        </div>

    </body>
    <div class="main-container">

        <div id="adminView" style="display: block; max-width: 800px; margin: 0 auto;">
            <a href="#" onclick="showSalesView()"
                style="display: block; margin: 0 0 20px 0; padding: 12px; background-color: #5cb85c; color: white; text-align: center; border-radius: 6px; text-decoration: none; font-weight: bold;">üí∏
                ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</a>

            <div class="left-panel" style="width: 100%;">

                <div class="header-top">
                    <h1>üõ†Ô∏è POS Tools</h1>
                    <div id="sessionStatus" class="status-inactive">‚ö†Ô∏è ‡¶∏‡ßá‡¶∂‡¶® ‡¶®‡ßá‡¶á</div>
                </div>



                <div class="action-card">
                    <h2>üì¶ ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶≤‡ßã‡¶° (Master)</h2>
                    <input type="file" id="excelFile" accept=".xlsx, .xls">
                    <button onclick="processExcel()" class="btn-info">Load Master Inventory</button>
                    <div id="import-status-message" class="info status-message">‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
                    <button onclick="downloadInventoryExcel()" style="background-color: #5bc0de;">‡¶∏‡ßç‡¶ü‡¶ï ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤
                        ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
                </div>

                <div class="action-card">
                    <h2>‚ûï ‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶® (GRN)</h2>
                    <input type="file" id="grnFile" accept=".xlsx, .xls">
                    <button onclick="processGRN()" style="background-color: #00bcd4;">Update Stock (GRN)</button>
                    <div id="grn-status-message" class="info status-message">GRN ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
                </div>

                <hr>

                <div id="history-section">
                    <h2 onclick="document.getElementById('hidden-history-details').style.display = document.getElementById('hidden-history-details').style.display === 'block' ? 'none' : 'block';"
                        style="cursor: pointer; background-color: #f0f0f0; padding: 10px; border-radius: 6px;">
                        üìú ‡¶¨‡¶ø‡¶≤ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø ‡¶ì ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü (Click to Expand)
                    </h2>
                    <div id="hidden-history-details" class="hidden-details">

                        <div class="action-card" style="padding: 10px;">
                            <h3>‡¶¨‡¶ø‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</h3>
                            <input type="text" id="billIdSearch" placeholder="INVYYMMDDXXXXX">
                            <button onclick="searchAndPrintBill()" class="btn-info" style="width: 100%;">‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ì
                                ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                        </div>

                        <div class="action-card" style="padding: 10px;">
                            <h3>‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞ ‡¶¨‡¶ø‡¶≤ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>
                            <label for="startDate">‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
                            <input type="date" id="startDate" style="width: 100%; margin-bottom: 5px;">
                            <label for="endDate">‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
                            <input type="date" id="endDate" style="width: 100%; margin-bottom: 10px;">
                            <button onclick="downloadBillHistory('excel')"
                                style="background-color: #5cb85c; width: 48%;">‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤</button>
                            <button onclick="downloadBillHistory('pdf')"
                                style="background-color: #d9534f; width: 48%;">PDF</button>
                        </div>

                        <div class="action-card" style="padding: 10px;">
                            <h3>‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶¨‡¶ø‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</h3>
                            <button onclick="downloadAllBills('excel')"
                                style="background-color: #f0ad4e; width: 48%;">‡¶∏‡¶¨
                                ‡¶¨‡¶ø‡¶≤ ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤</button>
                            <button onclick="downloadAllBills('pdf')" style="background-color: #dc3545; width: 48%;">‡¶∏‡¶¨
                                ‡¶¨‡¶ø‡¶≤
                                PDF</button>
                        </div>

                    </div>
                </div>

            </div>
        </div>

        <div id="salesView" style="display: none; width: 100%;">
            <a href="#" onclick="showAdminView()" id="adminToggleBtn"
                style="position: absolute; top: 30px; right: 30px; padding: 8px 15px; background-color: #f0ad4e; color: white; border-radius: 4px; text-decoration: none; z-index: 10;">üõ†Ô∏è
                ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶ü‡ßÅ‡¶≤‡¶∏</a>
            <div class="action-card">
                <h2>üë§ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡ßá‡¶∂‡¶®</h2>
                <label for="cashierId">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ID:</label>
                <input type="text" id="cashierId" placeholder="CAS001">
                <div style="display: flex; gap: 10px;">
                    <button onclick="startNewSession()" class="btn-success" style="flex: 1;">‡¶∏‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <button onclick="openCashClosingModal()" class="btn-warning" style="flex: 1;">‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂
                        ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç</button>
                </div>
            </div>
            <div class="right-panel" style="width: 100%; min-height: 90vh;">
                <h2>üí∞ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü (Sales)</h2>

                <div id="search-container">
                    <input type="text" id="search-input" placeholder="‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤, ‡¶¨‡¶æ‡¶∞‡¶ï‡ßã‡¶° ‡¶¨‡¶æ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® (Scan/Type)"
                        disabled>
                    <div id="suggestions"></div>
                </div>
                <div id="sales-status-message" class="info status-message">‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>

                <div class="sales-table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30%;">‡¶®‡¶æ‡¶Æ/‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                                <th style="width: 15%;">Article</th>
                                <th style="width: 15%;">‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)</th>
                                <th style="width: 15%;">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                                <th style="width: 15%;">‡¶Æ‡ßã‡¶ü (‡ß≥)</th>
                                <th style="width: 10%;">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #888; padding: 20px;">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
                                    ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="total-footer">
                    <strong>‡¶ó‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤:</strong>
                    <span id="grandTotal">0.00</span> ‡ß≥
                </div>

                <div class="payment-button-container">
                    <button onclick="openPaymentModal()" class="btn-success"
                        style="padding: 15px 30px; font-size: 1.2em;">
                        ‚úÖ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (F2)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="qtyModal" class="modal">
        <div class="modal-content">
            <h3>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Quantity)</h3>
            <p style="font-size: 1.1em; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 10px;">‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ:
                <span id="modalProductName" style="color: #007bff;"></span>
            </p>
            <label for="qtyInput">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®:</label>
            <input type="number" id="qtyInput" min="1" value="1" style="width: 100%;">
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="confirmQty()" class="btn-success">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button onclick="document.getElementById('qtyModal').style.display='none'"
                    style="background-color: #6c757d;">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h3>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
            <p id="payableAmount" style="background-color: #e6f7ff; color: #007bff;">‡¶¶‡ßá‡ßü ‡¶¨‡¶ø‡¶≤: 0.00 ‡ß≥</p>

            <div id="multiPaymentContainer">
            </div>
            <button onclick="addPaymentMethod()" class="btn-info" style="margin-bottom: 15px;">+ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßã‡¶° ‡¶Ø‡ßã‡¶ó
                ‡¶ï‡¶∞‡ßÅ‡¶®</button>

            <hr>

            <p id="receivedAmount" style="background-color: #f6ffed; color: #52c41a;">‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá: 0.00 ‡ß≥</p>
            <p id="changeAmount"
                style="font-size: 1.2em; background-color: #fff1f0; border-radius: 4px; padding: 10px;">‡¶´‡ßá‡¶∞‡¶§: 0.00 ‡ß≥</p>

            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="finalizePayment()" class="btn-success">‚úÖ ‡¶¨‡¶ø‡¶≤ ‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
                <button onclick="document.getElementById('paymentModal').style.display='none'"
                    style="background-color: #dc3545;">‚ùå ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
            </div>
        </div>
    </div>

    <div id="closingModal" class="modal">
        <div class="modal-content">
            <h3>üí∏ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç ‡¶ì ‡¶ó‡¶£‡¶®‡¶æ (Session: <span id="currentSessionDisplay" style="color: #007bff;">N/A</span>)
            </h3>

            <div id="denominationTable" class="action-card" style="background-color: #fcfcfc;">
                <h4>‡¶®‡ßã‡¶ü ‡¶ó‡¶£‡¶®‡¶æ</h4>
                <table id="cashCountTable">
                    <thead>
                        <tr>
                            <th style="width: 40%;">‡¶®‡ßã‡¶ü‡ßá‡¶∞ ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)</th>
                            <th style="width: 30%;">‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ (Qty)</th>
                            <th style="width: 30%;">‡¶Æ‡ßã‡¶ü (‡ß≥)</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div class="total-footer" style="flex-direction: column; align-items: flex-start; margin-top: 15px;">
                <h4>üìä ‡¶∏‡ßá‡¶∂‡¶® ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂</h4>
                <p>
                    <strong>‡¶Æ‡ßã‡¶ü ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂:</strong>
                    <span id="reportedCashDisplay"
                        style="font-size: 1.2em; color: #52c41a; font-weight: bold;">0.00</span> ‡ß≥
                </p>
                <div id="expectedCashRow" style="display: none;">
                    <strong>‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶§ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂:</strong>
                    <span id="expectedCashDisplay"
                        style="font-size: 1.2em; color: #007bff; font-weight: bold;">0.00</span> ‡ß≥
                </div>
                <div id="differenceRow" style="display: none; width: 100%;">
                    <strong style="font-size: 1.2em;">‡¶™‡¶æ‡¶∞‡ßç‡¶•‡¶ï‡ßç‡¶Ø (Difference):</strong>
                    <span id="differenceDisplay" style="font-size: 1.4em; font-weight: bold; color: #ff4d4f;">0.00
                        ‡ß≥</span>
                </div>
            </div>

            <div id="closingStatus" class="info status-message" style="margin-top: 10px;">‡¶ó‡¶£‡¶®‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®...</div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                <button onclick="closeSession()" class="btn-info">‚úÖ ‡¶∏‡ßá‡¶∂‡¶® ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ì ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡¶ø‡¶®</button>
                <button onclick="document.getElementById('closingModal').style.display='none'" class="delete-btn">‚ùå
                    ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
            </div>
        </div>
    </div>


    <script>
        // --- ‡¶®‡¶§‡ßÅ‡¶®: ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ì ‡¶∞‡ßã‡¶≤‡¶∏ ‡¶∏‡¶Ç‡¶ú‡ßç‡¶û‡¶æ (‡¶è‡¶ó‡ßÅ‡¶≤‡ßã ‡¶ñ‡ßÅ‡¶¨‡¶á insecure, ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶°‡ßá‡¶Æ‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø) ---
        const USERS = [
            { username: 'admin', password: '123', role: 'admin' }, // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞
            { username: 'cashier', password: '456', role: 'cashier' } // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞
            // ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶Ü‡¶∞‡¶ì ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®
        ];

        let loggedInUser = null; // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞

        // ... ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤...
        // --- ‡¶®‡¶§‡ßÅ‡¶®: ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ---
        function attemptLogin() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            const message = document.getElementById('loginMessage');

            const user = USERS.find(u => u.username === username && u.password === password);

            if (user) {
                loggedInUser = user;

                // ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤
                document.getElementById('loginModal').style.display = 'none'; // ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶π‡¶æ‡¶á‡¶°
                document.getElementById('mainContainer').style.display = 'block'; // ‡¶Æ‡ßÇ‡¶≤ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì
                message.textContent = '';

                handleSuccessfulLogin(user.role);

            } else {
                // ‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•
                message.textContent = '‡¶≠‡ßÅ‡¶≤ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°‡•§';
            }
        }

        // --- ‡¶∏‡¶´‡¶≤ ‡¶≤‡¶ó‡¶á‡¶®‡ßá‡¶∞ ‡¶™‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏ ‡¶®‡¶ø‡¶Ø‡¶º‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£ ---
        // --- ‡¶∏‡¶´‡¶≤ ‡¶≤‡¶ó‡¶á‡¶®‡ßá‡¶∞ ‡¶™‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏ ‡¶®‡¶ø‡¶Ø‡¶º‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£ ---
        function handleSuccessfulLogin(role) {
            const adminToggleBtn = document.getElementById('adminToggleBtn');
            const cashierIdInput = document.getElementById('cashierId'); // ‡¶®‡¶§‡ßÅ‡¶®: Cashier ID Input

            // 1. ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ID ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            if (cashierIdInput && loggedInUser) {
                cashierIdInput.value = loggedInUser.username; // ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶¨‡¶∏‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã
            }

            if (role === 'cashier') {
                // 2. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞: ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶≠‡¶ø‡¶â ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì ‡¶è‡¶¨‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã
                if (adminToggleBtn) adminToggleBtn.style.display = 'none';
                showSalesView();

                // 3. ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡ßá ‡¶∏‡ßá‡¶∂‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ö‡ßç‡¶õ‡ßá
                // Jehetu block-ti ekhon salesView-e, tai e-ti by default dekha jabe.
                // Tobe jodi e-ti cashierId hishebe use korte chan, tobe nishchit korun j kono user logged in thakle e-ti dekha jabe.

            } else if (role === 'admin') {
                // 4. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®: ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì
                if (adminToggleBtn) adminToggleBtn.style.display = 'inline-block';
                showAdminView();

                // 5. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ø‡¶¶‡¶ø ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶≠‡¶ø‡¶â-‡¶§‡ßá ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡ßá‡¶∂‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡¶ü‡¶ø ‡¶≤‡ßÅ‡¶ï‡¶ø‡ßü‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)
                // const sessionControls = document.getElementById('cashierSessionControls');
                // if (sessionControls) sessionControls.style.display = 'none';
            }

            // ... updateSessionDisplay(); (‡¶Ø‡¶¶‡¶ø ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá ‡¶•‡¶æ‡¶ï‡ßá) ...
        } // --- ‡¶®‡¶§‡ßÅ‡¶®: ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
        function showLoginPage() {
            // mainContainer ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶∞‡ßã POS ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü)
            const mainContainer = document.getElementById('mainContainer');
            if (mainContainer) {
                mainContainer.style.display = 'none';
            }

            // loginModal ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
            const loginModal = document.getElementById('loginModal');
            if (loginModal) {
                loginModal.style.display = 'flex';
            }

            // ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            loggedInUser = null;
            currentCashSession = null;
            sessionStartTimeStamp = null; // Sales ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ü‡¶ø ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£

            // ‡¶≤‡¶ó‡¶á‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            document.getElementById('passwordInput').value = '';
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('usernameInput').value = '';

            // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡ßá ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶ï‡¶∞‡¶æ
            document.getElementById('usernameInput').focus();
        }
        // --- ‡ßß. IndexedDB ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ‡¶ì ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ ---
        const DB_NAME = 'POSMasterDB_Final_V12'; // Version incremented for fix stability
        const INVENTORY_STORE_NAME = 'InventoryProducts';
        const BILLS_STORE_NAME = 'Bills';
        const SESSIONS_STORE_NAME = 'Sessions';
        const CLOSING_STORE_NAME = 'CashClosings';
        const DB_VERSION = 12; // Increased version for stability
        let db;
        let allProducts = [];
        let salesItems = [];
        let selectedProduct = null;
        let activeSuggestionIndex = -1;
        let currentPayments = [];
        // Helper function for safe number parsing
        function safeParseFloat(value) {
            const result = parseFloat(value);
            // ‡¶Ø‡¶¶‡¶ø ‡¶á‡¶®‡¶™‡ßÅ‡¶ü NaN ‡¶¨‡¶æ null ‡¶π‡¶Ø‡¶º, ‡¶§‡¶¨‡ßá 0 ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
            return isNaN(result) ? 0 : result;
        }

        function safeParseInt(value) {
            const result = parseInt(value);
            // ‡¶Ø‡¶¶‡¶ø ‡¶á‡¶®‡¶™‡ßÅ‡¶ü NaN ‡¶¨‡¶æ null ‡¶π‡¶Ø‡¶º, ‡¶§‡¶¨‡ßá 0 ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
            return isNaN(result) ? 0 : result;
        }
        // **‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡ßá‡¶∂‡¶® ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤**
        let currentCashierId = null;
        let currentSessionId = null;

        // **‡¶®‡ßã‡¶ü ‡¶ó‡¶£‡¶®‡¶æ ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤**
        const DENOMINATIONS = [1000, 500, 100, 50, 20, 10, 5, 2, 1];
        const PAYMENT_METHODS = ['Cash', 'Bkash', 'Bank'];


        // DOM Element References
        const searchInput = document.getElementById('search-input');
        const suggestionsDiv = document.getElementById('suggestions');
        const salesTableBody = document.getElementById('sales-table-body');
        const qtyModal = document.getElementById('qtyModal');
        const qtyInput = document.getElementById('qtyInput');
        const grandTotalSpan = document.getElementById('grandTotal');
        const importStatusMessage = document.getElementById('import-status-message');
        const salesStatusMessage = document.getElementById('sales-status-message');
        const paymentModal = document.getElementById('paymentModal');
        const payableAmountDiv = document.getElementById('payableAmount');
        const receivedAmountDiv = document.getElementById('receivedAmount');
        const changeAmountDiv = document.getElementById('changeAmount');
        const multiPaymentContainer = document.getElementById('multiPaymentContainer');
        const grnStatusMessage = document.getElementById('grn-status-message');
        const cashierIdInput = document.getElementById('cashierId');
        const sessionStatusDiv = document.getElementById('sessionStatus');
        const closingModal = document.getElementById('closingModal');
        const closingStatusDiv = document.getElementById('closingStatus');
        const billIdSearchInput = document.getElementById('billIdSearch');

        // Denomination DOMs
        const cashCountTableBody = document.querySelector('#cashCountTable tbody');
        const reportedCashDisplay = document.getElementById('reportedCashDisplay');
        const expectedCashDisplay = document.getElementById('expectedCashDisplay');
        const differenceDisplay = document.getElementById('differenceDisplay');
        const currentSessionDisplay = document.getElementById('currentSessionDisplay');


        // --- Debounce Function ---
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- ‡ß®. IndexedDB ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶®, ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶æ‡¶ï‡¶ö‡¶æ‡¶∞ ‡¶ì ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ---
        function openDatabaseAndLoadData() {
            if (salesStatusMessage) {
                salesStatusMessage.className = 'info status-message';
                salesStatusMessage.textContent = "‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            }

            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => {
                if (salesStatusMessage) {
                    salesStatusMessage.className = 'error status-message';
                    salesStatusMessage.textContent = "‚ùå ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: IndexedDB ‡¶ñ‡ßÅ‡¶≤‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§";
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                loadAllProducts();
                checkActiveSession();
            };

            request.onupgradeneeded = (event) => {
                const db = event.target.result;

                // Inventory Store
                if (db.objectStoreNames.contains(INVENTORY_STORE_NAME)) {
                    db.deleteObjectStore(INVENTORY_STORE_NAME);
                }
                const inventoryStore = db.createObjectStore(INVENTORY_STORE_NAME, { autoIncrement: true });
                inventoryStore.createIndex('Article', 'Article', { unique: false });
                inventoryStore.createIndex('Barcode', 'Barcode', { unique: false });
                inventoryStore.createIndex('Description', 'Description', { unique: false });

                // Bills Store
                if (db.objectStoreNames.contains(BILLS_STORE_NAME)) {
                    db.deleteObjectStore(BILLS_STORE_NAME);
                }
                const billsStore = db.createObjectStore(BILLS_STORE_NAME, { keyPath: 'id' });
                billsStore.createIndex('date', 'date', { unique: false });
                billsStore.createIndex('cashierId', 'cashierId', { unique: false });
                billsStore.createIndex('sessionId', 'sessionId', { unique: false });

                // Sessions Store
                if (db.objectStoreNames.contains(SESSIONS_STORE_NAME)) {
                    db.deleteObjectStore(SESSIONS_STORE_NAME);
                }
                const sessionsStore = db.createObjectStore(SESSIONS_STORE_NAME, { keyPath: 'sessionId' });
                sessionsStore.createIndex('cashierId', 'cashierId', { unique: false });
                sessionsStore.createIndex('startTime', 'startTime', { unique: false });

                // Cash Closing History Store 
                if (db.objectStoreNames.contains(CLOSING_STORE_NAME)) {
                    db.deleteObjectStore(CLOSING_STORE_NAME);
                }
                const closingsStore = db.createObjectStore(CLOSING_STORE_NAME, { autoIncrement: true });
                closingsStore.createIndex('sessionId', 'sessionId', { unique: false });
            };
        }

        function loadAllProducts() {
            if (!db) return;

            if (salesStatusMessage) {
                salesStatusMessage.className = 'info status-message';
                salesStatusMessage.textContent = "‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            }

            const transaction = db.transaction([INVENTORY_STORE_NAME], 'readonly');
            const objectStore = transaction.objectStore(INVENTORY_STORE_NAME);

            allProducts = [];
            objectStore.openCursor().onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const product = cursor.value;
                    product.key = cursor.key;
                    allProducts.push(product);
                    cursor.continue();
                } else {
                    if (allProducts.length > 0) {
                        if (salesStatusMessage) {
                            salesStatusMessage.className = 'success status-message';
                            salesStatusMessage.textContent = `‚úÖ ${allProducts.length} ‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`;
                        }
                        if (searchInput) searchInput.disabled = false;
                        if (searchInput) searchInput.focus();
                    } else {
                        if (salesStatusMessage) {
                            salesStatusMessage.className = 'error status-message';
                            salesStatusMessage.textContent = "‚ö†Ô∏è ‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶â‡¶™‡¶∞‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                        }
                        if (searchInput) searchInput.disabled = true;
                    }
                }
            };
        }

        // --- ‡ß©. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡ßá‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ---

        function checkActiveSession() {
            // localStorage ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∏‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
            currentSessionId = localStorage.getItem('activeSessionId');
            currentCashierId = localStorage.getItem('activeCashierId');

            if (currentSessionId) {
                // ‡¶Ø‡¶¶‡¶ø ‡¶∏‡ßá‡¶∂‡¶® ‡¶ö‡¶≤‡ßá
                // ‡¶Ø‡¶¶‡¶ø currentCashierId ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶∏‡ßá‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶®‡¶ü‡¶ø‡¶ï‡ßá ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Æ‡¶æ‡¶® ‡¶¨‡¶æ 'CAS001' ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ß‡¶∞‡ßá ‡¶®‡ßá‡¶¨‡ßá
                currentCashierId = currentCashierId || cashierIdInput.value.trim() || 'CAS001';

                updateSessionStatus(`‚úÖ ‡¶∏‡ßá‡¶∂‡¶®: ${currentSessionId} | ${currentCashierId}`);
                if (cashierIdInput) {
                    cashierIdInput.value = currentCashierId;
                    cashierIdInput.disabled = true; // ‡¶∏‡ßá‡¶∂‡¶® ‡¶ö‡¶≤‡¶≤‡ßá ‡¶Ö‡¶ï‡ßç‡¶∑‡¶Æ
                }
                if (currentSessionDisplay) currentSessionDisplay.textContent = currentSessionId;
                if (searchInput) searchInput.disabled = false; // ‡¶∏‡ßá‡¶∂‡¶® ‡¶ö‡¶≤‡¶≤‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º
            } else {
                // ‡¶Ø‡¶¶‡¶ø ‡¶∏‡ßá‡¶∂‡¶® ‡¶¨‡¶®‡ßç‡¶ß ‡¶•‡¶æ‡¶ï‡ßá
                updateSessionStatus(`‚ö†Ô∏è ‡¶∏‡ßá‡¶∂‡¶® ‡¶®‡ßá‡¶á`);

                // üî• ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï: ‡¶∏‡ßá‡¶∂‡¶® ‡¶¨‡¶®‡ßç‡¶ß ‡¶•‡¶æ‡¶ï‡¶≤‡ßá, ‡¶¨‡¶ï‡ßç‡¶∏‡¶ü‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶ï‡ßç‡¶∑‡¶Æ ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶Æ‡¶æ‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§
                if (cashierIdInput) {
                    cashierIdInput.value = ''; // ‡¶Ü‡¶á‡¶°‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶≤‡ßã
                    cashierIdInput.disabled = false; // ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶ï‡ßç‡¶∑‡¶Æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                }

                currentSessionId = null;
                currentCashierId = null;
                if (currentSessionDisplay) currentSessionDisplay.textContent = 'N/A';
                if (searchInput) searchInput.disabled = true; // ‡¶∏‡ßá‡¶∂‡¶® ‡¶®‡¶æ ‡¶ö‡¶≤‡¶≤‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º
            }
        }

        window.startNewSession = function () {
            if (!cashierIdInput) return alert("Cashier ID ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶° HTML ‡¶è ‡¶®‡ßá‡¶á‡•§");

            const cashier = cashierIdInput.value.trim().toUpperCase();

            if (currentSessionId) return alert(`‚ùå ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶∂‡¶® ‡¶ö‡¶≤‡¶õ‡ßá: ${currentSessionId}! ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`);

            if (!cashier) {
                alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®‡•§");
                return;
            }

            const newSessionId = `SESS${Date.now()}`;

            const newSession = {
                sessionId: newSessionId,
                cashierId: cashier,
                startTime: new Date().toISOString(),
                status: 'OPEN',
                initialCash: 0
            };

            const transaction = db.transaction([SESSIONS_STORE_NAME], 'readwrite');
            const store = transaction.objectStore(SESSIONS_STORE_NAME);

            const request = store.add(newSession);

            request.onsuccess = () => {
                currentSessionId = newSessionId;
                currentCashierId = cashier;
                localStorage.setItem('activeSessionId', newSessionId);
                localStorage.setItem('activeCashierId', cashier);

                // ‡¶∏‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞ UI ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                updateSessionStatus(`‚úÖ ‡¶∏‡ßá‡¶∂‡¶®: ${currentSessionId} | ${currentCashierId}`);
                if (cashierIdInput) cashierIdInput.disabled = true; // ‡¶∏‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶≤‡ßá ‡¶Ö‡¶ï‡ßç‡¶∑‡¶Æ
                if (currentSessionDisplay) currentSessionDisplay.textContent = currentSessionId;
                if (searchInput) searchInput.disabled = false; // ‡¶∏‡ßá‡¶∂‡¶® ‡¶ö‡¶≤‡¶≤‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º

                // ‡¶∏‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶ö‡¶≤‡ßá ‡¶Ø‡¶æ‡¶ì
                showSalesView();
            };

            request.onerror = (e) => {
                alert("‡¶∏‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + e.target.error.message);
            };
        }

        function updateSessionStatus(message) {
            if (sessionStatusDiv) {
                sessionStatusDiv.textContent = message;
                sessionStatusDiv.className = currentSessionId ? 'status-active' : 'status-inactive';
            }
        }

        // --- ‡ß™. ‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï (Excel to IndexedDB) ---

        function saveToIndexedDB(dataArray) {
            if (!db) {
                if (importStatusMessage) {
                    importStatusMessage.className = 'error status-message';
                    importStatusMessage.textContent = "‚ùå ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: IndexedDB ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶®‡¶Ø‡¶º‡•§ ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                }
                return;
            }

            const transaction = db.transaction([INVENTORY_STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(INVENTORY_STORE_NAME);
            let count = 0;
            let errorCount = 0;

            objectStore.clear();

            dataArray.forEach((item) => {
                if (!item.Article) { errorCount++; return; }
                const request = objectStore.add(item);
                request.onsuccess = () => {
                    count++;
                };
                request.onerror = (e) => {
                    console.error("‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ:", e);
                    errorCount++;
                };
            });

            transaction.oncomplete = () => {
                if (importStatusMessage) {
                    importStatusMessage.className = 'success status-message';
                    let message = `‚úÖ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ${count} ‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`;
                    if (errorCount > 0) {
                        message += `\n‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ${errorCount} ‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶¨‡¶æ‡¶¶ ‡¶™‡ßú‡ßá‡¶õ‡ßá (Article ‡¶õ‡¶æ‡ßú‡¶æ)‡•§`;
                    }
                    importStatusMessage.textContent = message;
                }
                loadAllProducts();
            };

            transaction.onerror = (e) => {
                if (importStatusMessage) {
                    importStatusMessage.className = 'error status-message';
                    importStatusMessage.textContent = "‚ùå ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: " + e.target.error;
                }
            };
        }

        window.processExcel = function () {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            if (!file) {
                if (importStatusMessage) {
                    importStatusMessage.className = 'error status-message';
                    importStatusMessage.textContent = "‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                }
                return;
            }

            if (importStatusMessage) {
                importStatusMessage.className = 'info status-message';
                importStatusMessage.textContent = `‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶°‡¶º‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: ${file.name}...`;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonArray = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonArray.length < 2) {
                        if (importStatusMessage) {
                            importStatusMessage.className = 'error status-message';
                            importStatusMessage.textContent = "‚ùå ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§";
                        }
                        return;
                    }

                    const rawHeaders = jsonArray[0];
                    // ‡¶π‡ßá‡¶°‡¶æ‡¶∞‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶™‡ßá‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶ö‡¶ø‡¶π‡ßç‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ
                    const standardizedHeaders = rawHeaders.map(h => {
                        if (h) { return String(h).trim().replace(/\s+/g, ''); }
                        return '';
                    });
                    const rawData = jsonArray.slice(1);

                    const products = rawData.map(row => {
                        const rawObj = {};
                        standardizedHeaders.forEach((header, index) => {
                            if (header && row[index] !== undefined) {
                                rawObj[header] = row[index] === null || row[index] === undefined ? '' : row[index];
                            }
                        });

                        // --- üî• ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ü‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∂‡¶ï‡ßç‡¶§‡¶ø‡¶∂‡¶æ‡¶≤‡ßÄ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡¶ø‡¶Ç ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ---
                        const product = {};

                        // Article: 'Article', 'article' ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø
                        product.Article = String(rawObj.Article || rawObj.article || '').trim();

                        // Barcode: 'Barcode', 'barcode', 'BarCode' ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø
                        product.Barcode = String(rawObj.Barcode || rawObj.barcode || rawObj.BarCode || '').trim();

                        // Description: 'Description', 'description', 'Name' ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø
                        product.Description = String(rawObj.Description || rawObj.description || rawObj.Name || rawObj.name || '').trim();

                        // SalePrice FIX: 'SalePrice', 'Price', 'SellingPrice' ‡¶¨‡¶æ 'MRP' ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
                        const priceValue = rawObj.SalePrice || rawObj.Price || rawObj.SellingPrice || rawObj.MRP || rawObj.price || 0;
                        product.SalePrice = parseFloat(priceValue) || 0;

                        // CurrentStock FIX: 'CurrentStock', 'Stock', 'Qty' ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
                        const stockValue = rawObj.CurrentStock || rawObj.Stock || rawObj.Qty || rawObj.stock || 0;
                        product.CurrentStock = parseFloat(stockValue) || 0;

                        // ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶Ö‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶ï‡¶≤‡¶æ‡¶Æ‡¶ó‡ßÅ‡¶≤‡¶ø‡¶ì ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                        Object.keys(rawObj).forEach(key => {
                            // Already mapped keys (Article, Barcode, etc) ‡¶è‡¶°‡¶º‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ
                            if (!product.hasOwnProperty(key) && !product.hasOwnProperty(key.toLowerCase())) {
                                product[key] = rawObj[key];
                            }
                        });

                        // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ Article ‡¶Ü‡¶õ‡ßá ‡¶è‡¶Æ‡¶® ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡¶æ
                        return product.Article ? product : null;

                    }).filter(p => p !== null); // null ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ

                    saveToIndexedDB(products);

                } catch (error) {
                    if (importStatusMessage) {
                        importStatusMessage.className = 'error status-message';
                        importStatusMessage.textContent = "‚ùå ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£‡ßá ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + error.message;
                    }
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- ‡ß´. GRN ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï ---

        window.processGRN = function () {
            const fileInput = document.getElementById('grnFile');
            const file = fileInput.files[0];
            if (!file) {
                if (grnStatusMessage) {
                    grnStatusMessage.className = 'error status-message';
                    grnStatusMessage.textContent = "‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø GRN ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                }
                return;
            }

            if (grnStatusMessage) {
                grnStatusMessage.className = 'info status-message';
                grnStatusMessage.textContent = `GRN ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶°‡¶º‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: ${file.name}...`;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const grnData = XLSX.utils.sheet_to_json(worksheet);

                    if (grnData.length === 0) {
                        if (grnStatusMessage) {
                            grnStatusMessage.className = 'error status-message';
                            grnStatusMessage.textContent = "‚ùå GRN ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§";
                        }
                        return;
                    }

                    updateStockFromGRN(grnData);

                } catch (error) {
                    if (grnStatusMessage) {
                        grnStatusMessage.className = 'error status-message';
                        grnStatusMessage.textContent = "‚ùå GRN ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£‡ßá ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + error.message;
                    }
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function updateStockFromGRN(grnItems) {
            if (!db) return;

            const transaction = db.transaction([INVENTORY_STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(INVENTORY_STORE_NAME);
            const articleIndex = objectStore.index('Article');
            let updateCount = 0;
            let notFoundCount = 0;

            grnItems.forEach(item => {
                // Header-‡¶è‡¶∞ ‡¶≠‡¶ø‡¶®‡ßç‡¶®‡¶§‡¶æ ‡¶Æ‡ßá‡¶ü‡¶æ‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶®‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
                const article = String(item.Article || item.article || '').trim();
                const qty = parseFloat(item.ReceivedQty || item.Qty || item.qty) || 0;

                if (!article || qty <= 0) return;

                const getRequest = articleIndex.openCursor(article);

                getRequest.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const product = cursor.value;
                        const dbKey = cursor.primaryKey;
                        const currentStock = parseFloat(product.CurrentStock) || 0;
                        product.CurrentStock = currentStock + qty;
                        product.LastGRN = new Date().toISOString(); // ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶°

                        const updateRequest = objectStore.put(product, dbKey);
                        updateRequest.onsuccess = () => {
                            updateCount++;
                        };
                        cursor.continue();
                    } else {
                        notFoundCount++;
                    }
                };
            });

            transaction.oncomplete = () => {
                if (grnStatusMessage) {
                    grnStatusMessage.className = 'success status-message';
                    let message = `‚úÖ GRN ‡¶∏‡¶´‡¶≤! ${updateCount} ‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`;
                    if (notFoundCount > 0) {
                        message += `\n‚ö†Ô∏è ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ${notFoundCount} ‡¶ü‡¶ø Article ‡¶Æ‡¶æ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§`;
                    }
                    grnStatusMessage.textContent = message;
                }
                loadAllProducts();
            };

            transaction.onerror = (event) => {
                if (grnStatusMessage) {
                    grnStatusMessage.className = 'error status-message';
                    grnStatusMessage.textContent = "‚ùå GRN ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: " + event.target.error;
                }
            };
        }

        function updateMasterStock(itemsToUpdate) {
            if (!db) return;

            const transaction = db.transaction([INVENTORY_STORE_NAME], 'readwrite');
            const objectStore = transaction.objectStore(INVENTORY_STORE_NAME);

            itemsToUpdate.forEach(saleItem => {
                const dbKey = saleItem.key;
                const getRequest = objectStore.get(dbKey);

                getRequest.onsuccess = (event) => {
                    const product = event.target.result;
                    if (product) {
                        const currentStock = parseFloat(product.CurrentStock) || 0;
                        const newStock = currentStock - saleItem.Qty;
                        product.CurrentStock = Math.max(0, newStock);

                        objectStore.put(product, dbKey);
                    }
                };
            });

            transaction.oncomplete = () => {
                loadAllProducts();
            };
        }

        // --- ‡ß¨. ‡¶∏‡ßá‡¶≤‡¶∏ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶≤‡¶ú‡¶ø‡¶ï (Search, Suggestion, QTY, Table) ---

        const debouncedSearch = debounce((query) => {
            if (query.length === 0) {
                if (suggestionsDiv) suggestionsDiv.style.display = 'none';
                return;
            }

            const filtered = allProducts.filter(p =>
                (p.Barcode && String(p.Barcode).toLowerCase().includes(query)) ||
                (p.Article && String(p.Article).toLowerCase().includes(query)) ||
                (p.Description && String(p.Description).toLowerCase().includes(query))
            );

            displaySuggestions(filtered);
        }, 300);

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                debouncedSearch(e.target.value.toLowerCase().trim());
            });

            searchInput.addEventListener('keydown', (e) => {
                const suggestions = suggestionsDiv ? Array.from(suggestionsDiv.children) : [];

                if (suggestions.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeSuggestionIndex = (activeSuggestionIndex + 1) % suggestions.length;
                    updateActiveSuggestion(suggestions);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeSuggestionIndex = (activeSuggestionIndex - 1 + suggestions.length) % suggestions.length;
                    updateActiveSuggestion(suggestions);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (activeSuggestionIndex >= 0) {
                        suggestions[activeSuggestionIndex].click();
                    } else if (suggestions.length === 1 && searchInput.value.length > 0) {
                        // If only one suggestion remains, auto-select it
                        suggestions[0].click();
                    }
                }
            });
        }

        function displaySuggestions(products) {
            if (!suggestionsDiv) return;

            suggestionsDiv.innerHTML = '';
            activeSuggestionIndex = -1;

            if (products.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            products.slice(0, 10).forEach(product => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.dataset.key = product.key; // Store the IndexedDB key

                item.innerHTML = `
                <div>
                    <strong>${product.Description || 'N/A'}</strong> 
                    <div class="barcode-sku">
                        <span>Article: ${product.Article || 'N/A'}</span>
                        <span>Barcode: ${product.Barcode || 'N/A'}</span>
                    </div>
                </div>
                <div class="stock-info">
                    ‡ß≥ ${product.SalePrice ? parseFloat(product.SalePrice).toFixed(2) : '0.00'} | 
                    Stock: ${product.CurrentStock || 0}
                </div>
            `;

                item.onclick = () => {
                    selectProduct(product);
                };
                suggestionsDiv.appendChild(item);
            });

            suggestionsDiv.style.display = 'block';
        }

        function updateActiveSuggestion(suggestions) {
            suggestions.forEach((item, index) => {
                item.classList.remove('active');
                if (index === activeSuggestionIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest' });
                }
            });
        }

        function selectProduct(product) {
            selectedProduct = product;
            if (searchInput) searchInput.value = '';
            if (suggestionsDiv) suggestionsDiv.style.display = 'none';

            // Check if item is already in sales list
            const existingItem = salesItems.find(item => item.key === selectedProduct.key);
            const currentStock = parseFloat(selectedProduct.CurrentStock) || 0;
            const currentQty = existingItem ? existingItem.Qty : 0;

            if (currentStock <= currentQty) {
                alert(`‚ùå ‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡ßá‡¶∑! ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ${currentStock} ‡¶™‡¶ø‡¶∏ ‡¶Ü‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ${currentQty} ‡¶™‡¶ø‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§`);
                if (searchInput) searchInput.focus();
                return;
            }

            // Update modal product name
            const modalProductName = document.getElementById('modalProductName');
            if (modalProductName) modalProductName.textContent = product.Description || product.Article || 'N/A';

            if (qtyInput) qtyInput.value = 1;

            if (qtyModal) qtyModal.style.display = 'block';

            if (qtyInput) {
                qtyInput.focus();
                qtyInput.select();
                qtyInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        confirmQty();
                    }
                };
            }
        }

        window.confirmQty = function () {
            if (!selectedProduct || !qtyInput) return;

            const qty = parseInt(qtyInput.value);
            if (isNaN(qty) || qty <= 0) {
                alert("‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç ‡ßß ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
                qtyInput.focus();
                qtyInput.select();
                return;
            }

            const currentStock = parseFloat(selectedProduct.CurrentStock) || 0;
            // Check if item is already in sales list and calculate total quantity
            const existingItem = salesItems.find(item => item.key === selectedProduct.key);
            const totalQtyNeeded = qty + (existingItem ? existingItem.Qty : 0);

            if (currentStock < totalQtyNeeded) {
                alert(`‚ùå ‡¶∏‡ßç‡¶ü‡¶ï ‡¶ï‡¶Æ ‡¶Ü‡¶õ‡ßá! ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ${currentStock} ‡¶™‡¶ø‡¶∏ ‡¶Ü‡¶õ‡ßá‡•§ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ${existingItem ? existingItem.Qty : 0} ‡¶™‡¶ø‡¶∏ ‡¶Ü‡¶õ‡ßá‡•§`);
                qtyInput.focus();
                qtyInput.select();
                return;
            }

            addSalesItem(selectedProduct, qty);

            if (qtyModal) qtyModal.style.display = 'none';
            if (searchInput) searchInput.focus();
        }

        function addSalesItem(product, qty) {
            const existingItemIndex = salesItems.findIndex(item => item.key === product.key);

            const salePrice = parseFloat(product.SalePrice) || 0;
            const name = product.Description || product.Article;
            const article = product.Article;

            if (existingItemIndex > -1) {
                // Update quantity if item exists
                salesItems[existingItemIndex].Qty += qty;
                salesItems[existingItemIndex].Total = salesItems[existingItemIndex].Qty * salePrice;
            } else {
                // Add new item
                salesItems.push({
                    key: product.key,
                    Name: name,
                    Article: article,
                    SalePrice: salePrice,
                    Qty: qty,
                    Total: qty * salePrice
                });
            }

            renderSalesTable();
        }

        window.deleteSalesItem = function (key) {
            salesItems = salesItems.filter(item => item.key !== key);
            renderSalesTable();
            if (searchInput) searchInput.focus();
        }

        function renderSalesTable() {
            if (!salesTableBody || !grandTotalSpan) return;

            salesTableBody.innerHTML = '';
            let grandTotal = 0;

            if (salesItems.length === 0) {
                salesTableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; color: #888; padding: 20px;">‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</td>
                </tr>
            `;
            } else {
                salesItems.forEach(item => {
                    grandTotal += item.Total;
                    salesTableBody.innerHTML += `
                    <tr>
                        <td>${item.Name}</td>
                        <td>${item.Article}</td>
                        <td>${item.SalePrice.toFixed(2)}</td>
                        <td>${item.Qty}</td>
                        <td>${item.Total.toFixed(2)}</td>
                        <td><button class="delete-btn" onclick="deleteSalesItem(${item.key})">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button></td>
                    </tr>
                `;
                });
            }

            grandTotalSpan.textContent = grandTotal.toFixed(2);
        }

        // --- ‡ß≠. ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ì ‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï ---

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (qtyModal && qtyModal.style.display === 'block') {
                    qtyModal.style.display = 'none';
                    if (searchInput) searchInput.focus();
                } else if (paymentModal && paymentModal.style.display === 'block') {
                    paymentModal.style.display = 'none';
                    if (searchInput) searchInput.focus();
                } else if (closingModal && closingModal.style.display === 'block') {
                    closingModal.style.display = 'none';
                }
            }

            if (e.key === 'F2') {
                e.preventDefault();
                if (closingModal && closingModal.style.display === 'block') return;
                if (salesItems.length === 0) {
                    alert("‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡ßü ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶®‡ßá‡¶á!");
                    return;
                }

                // If payment modal is open, finalize, otherwise open it.
                if (paymentModal && paymentModal.style.display === 'block') {
                    finalizePayment();
                } else {
                    openPaymentModal();
                }
            }
        });

        window.openPaymentModal = function () {
            if (salesItems.length === 0) return;
            if (!currentSessionId) {
                alert("‚ùå ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                return;
            }

            currentPayments = [];
            addPaymentMethod(true); // Add 'Cash' payment by default
            calculatePaymentTotals();

            if (paymentModal) paymentModal.style.display = 'block';

            const firstInput = multiPaymentContainer ? multiPaymentContainer.querySelector('input[type="number"]') : null;
            if (firstInput) {
                firstInput.focus();
                firstInput.select();
            }
        }

        window.addPaymentMethod = function (isInitial = false) {
            const defaultMethod = 'Cash';
            const payable = parseFloat(grandTotalSpan ? grandTotalSpan.textContent : 0) || 0;
            const received = currentPayments.reduce((sum, p) => sum + p.amount, 0);

            // Calculate remaining amount to pay
            const remaining = Math.max(0, payable - received);

            // For the first payment, it's the full payable amount. For subsequent, it's the remaining.
            const defaultAmount = isInitial ? payable : remaining;

            const newPayment = { method: defaultMethod, amount: defaultAmount };
            currentPayments.push(newPayment);
            renderPaymentMethods();
        }

        window.removePaymentMethod = function (index) {
            currentPayments.splice(index, 1);
            renderPaymentMethods();
        }

        function renderPaymentMethods() {
            if (!multiPaymentContainer) return;

            multiPaymentContainer.innerHTML = '';

            currentPayments.forEach((payment, index) => {
                const div = document.createElement('div');
                div.className = 'payment-line';

                // Method Selector
                const select = document.createElement('select');
                select.className = 'payment-method-select';
                select.onchange = (e) => {
                    payment.method = e.target.value;
                    calculatePaymentTotals();
                };
                PAYMENT_METHODS.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method;
                    option.textContent = method;
                    if (method === payment.method) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                // Amount Input
                const input = document.createElement('input');
                input.type = 'number';
                input.placeholder = 'Amount';
                input.value = payment.amount.toFixed(2);
                input.oninput = (e) => {
                    payment.amount = parseFloat(e.target.value) || 0;
                    calculatePaymentTotals();
                };

                // Remove Button
                const removeButton = document.createElement('button');
                removeButton.textContent = 'X';
                removeButton.className = 'delete-btn remove-payment-btn';
                removeButton.onclick = () => removePaymentMethod(index);

                div.appendChild(select);
                div.appendChild(input);
                if (currentPayments.length > 1) {
                    div.appendChild(removeButton);
                }

                multiPaymentContainer.appendChild(div);
            });
            calculatePaymentTotals();
        }


        function calculatePaymentTotals() {
            const payable = parseFloat(grandTotalSpan ? grandTotalSpan.textContent : 0) || 0;
            const received = currentPayments.reduce((sum, p) => sum + p.amount, 0);
            const change = received - payable;

            if (payableAmountDiv) payableAmountDiv.textContent = `‡¶¶‡ßá‡ßü ‡¶¨‡¶ø‡¶≤: ${payable.toFixed(2)} ‡¶ü‡¶æ‡¶ï‡¶æ`;
            if (receivedAmountDiv) receivedAmountDiv.textContent = `‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá: ${received.toFixed(2)} ‡¶ü‡¶æ‡¶ï‡¶æ`;
            if (changeAmountDiv) {
                changeAmountDiv.textContent = `‡¶´‡ßá‡¶∞‡¶§: ${Math.abs(change).toFixed(2)} ‡¶ü‡¶æ‡¶ï‡¶æ`;
                changeAmountDiv.style.color = change < 0 ? '#cc3300' : '#28a745';
                changeAmountDiv.style.backgroundColor = change < 0 ? '#fff1f0' : '#f6ffed';
            }
            return { payable, received, change };
        }

        function generateUniqueBillId() {
            const date = new Date();
            const yymmdd = date.toISOString().slice(2, 10).replace(/-/g, '');
            const counter = (Date.now() % 100000).toString().padStart(5, '0');
            return `INV${yymmdd}${counter}`;
        }

        window.finalizePayment = function () {
            if (!currentSessionId) {
                alert("‚ùå ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                return;
            }

            const { payable, received, change } = calculatePaymentTotals();

            if (received < payable) {
                alert("‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ö‡ßá‡ßü‡ßá ‡¶ï‡¶Æ! ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§");
                return;
            }

            // Stock update happens before saving bill
            updateMasterStock(salesItems);

            const billId = generateUniqueBillId();
            const now = new Date();

            // Only save payments with amount > 0
            const finalPayments = currentPayments.filter(p => p.amount > 0);

            const newBill = {
                id: billId,
                date: now.toISOString(),
                items: JSON.parse(JSON.stringify(salesItems)),
                payments: finalPayments,
                payable: payable,
                received: received,
                change: change,
                cashierId: currentCashierId,
                sessionId: currentSessionId,
                timestamp: now.getTime()
            };

            saveBillToIndexedDB(newBill);
            printBill(newBill);

            if (paymentModal) paymentModal.style.display = 'none';
            salesItems = [];
            renderSalesTable();
            if (searchInput) searchInput.focus();

            alert(`‚úÖ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®‡•§ ‡¶¨‡¶ø‡¶≤ ID: ${billId}‡•§ ‡¶´‡ßá‡¶∞‡¶§: ${change.toFixed(2)} ‡¶ü‡¶æ‡¶ï‡¶æ‡•§`);
        }

        function saveBillToIndexedDB(bill) {
            if (!db) return;
            const transaction = db.transaction([BILLS_STORE_NAME], 'readwrite');
            const store = transaction.objectStore(BILLS_STORE_NAME);
            const request = store.add(bill);
            request.onsuccess = () => {
                console.log(`Bill ${bill.id} saved.`);
            };
            request.onerror = (e) => {
                alert("‡¶¨‡¶ø‡¶≤ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + e.target.error.message);
            };
        }

        // --- ‡ßÆ. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï (Blind Closing) ---

        function renderDenominationTable() {
            if (!cashCountTableBody) return;

            cashCountTableBody.innerHTML = '';

            DENOMINATIONS.forEach(value => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${value} ‡ß≥</td>
                    <td><input type="number" data-value="${value}" min="0" value="0" oninput="calculateReportedCash()" style="width: 80px; padding: 5px;"></td>
                    <td id="total-${value}">0.00 ‡ß≥</td>
                `;
                cashCountTableBody.appendChild(row);
            });
            calculateReportedCash(); // Initial calculation
        }

        // --- üî• ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: window.calculateReportedCash (Difference ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶¨‡¶®‡ßç‡¶ß) ---
        window.calculateReportedCash = function (expectedCash = 0) {
            let reportedTotal = 0;

            // 1. ‡¶®‡ßã‡¶ü ‡¶ó‡¶£‡¶®‡¶æ
            const inputs = document.querySelectorAll('#cashCountTable input[type="number"]');

            inputs.forEach(input => {
                const value = parseFloat(input.dataset.value);
                const qty = parseInt(input.value) || 0;
                const total = value * qty;
                reportedTotal += total;

                // ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶∏‡ßá‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                const totalCell = document.getElementById(`total-${value}`);
                if (totalCell) totalCell.textContent = total.toFixed(2) + ' ‡ß≥';
            });

            // 2. ‡¶™‡¶æ‡¶∞‡ßç‡¶•‡¶ï‡ßç‡¶Ø ‡¶ó‡¶£‡¶®‡¶æ (‡¶≤‡¶ú‡¶ø‡¶ï ‡¶Ö‡¶ï‡ßç‡¶∑‡¶§, ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶è‡¶ü‡¶ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞)
            const difference = reportedTotal - expectedCash;

            // 3. ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            if (reportedCashDisplay) reportedCashDisplay.textContent = reportedTotal.toFixed(2);

            // üî• ‡¶™‡¶æ‡¶∞‡ßç‡¶•‡¶ï‡ßç‡¶Ø ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ, ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Æ‡¶æ‡¶®‡¶ü‡¶ø ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§
            // if(differenceDisplay) { ... } <--- ‡¶è‡¶á ‡¶¨‡ßç‡¶≤‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶∞ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ

            return reportedTotal;
        }

        window.openCashClosingModal = function () {
            const activeSession = localStorage.getItem('activeSessionId');
            if (!activeSession) {
                alert("‚ùå ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®!");
                return;
            }

            currentSessionId = activeSession;
            currentCashierId = localStorage.getItem('activeCashierId') || 'N/A';

            if (closingModal) closingModal.style.display = 'block';

            renderDenominationTable();
            if (closingStatusDiv) closingStatusDiv.textContent = '‡¶¨‡¶ø‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            if (closingStatusDiv) closingStatusDiv.className = 'info status-message';

            if (currentSessionDisplay) currentSessionDisplay.textContent = currentSessionId;
            loadExpectedCashAndOpenClosing();
        }

        // --- üî• ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: loadExpectedCashAndOpenClosing (Blind Closing ‡¶≤‡¶ú‡¶ø‡¶ï) ---
        // --- ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: loadExpectedCashAndOpenClosing ---
        // --- ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: loadExpectedCashAndOpenClosing (with Debugging Logs) ---
        function loadExpectedCashAndOpenClosing() {
            if (!db) return;

            // Expected Cash ‡¶ì Difference ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ (Blind Closing ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
            const expectedCashRow = document.getElementById('expectedCashRow');
            if (expectedCashRow) expectedCashRow.style.display = 'none';
            const differenceRow = document.getElementById('differenceRow');
            if (differenceRow) differenceRow.style.display = 'none';


            const transaction = db.transaction([BILLS_STORE_NAME], 'readonly');
            const billsStore = transaction.objectStore(BILLS_STORE_NAME);
            const sessionIndex = billsStore.index('sessionId');

            let totalNetCashSales = 0; // ‡¶Æ‡ßã‡¶ü ‡¶®‡ßá‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü (Gross Cash Received - Change Returned)

            // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßá‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ï‡¶®‡¶∏‡ßã‡¶≤-‡¶è ‡¶¶‡ßá‡¶ñ‡¶æ
            console.log(`[CLOSING] Searching bills for active session ID: ${currentSessionId}`);

            const request = sessionIndex.openCursor(currentSessionId);

            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const bill = cursor.value;

                    // Step 1: Find the cash amount paid by the customer
                    const cashPaymentAmount = bill.payments.reduce((sum, p) =>
                        p.method === 'Cash' ? sum + safeParseFloat(p.amount) : sum, 0
                    );

                    // Step 2: Calculate the net cash that remains in the drawer.
                    const netCashFromBill = cashPaymentAmount - safeParseFloat(bill.change);

                    totalNetCashSales += netCashFromBill;

                    // --- DEBUG LOGS (F12 Console ‡¶è ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®) ---
                    console.log(`--- Bill ID: ${bill.id} ---`);
                    console.log(`Bill Change: ${safeParseFloat(bill.change)}`);
                    console.log(`Cash Payment Amount (Received): ${cashPaymentAmount}`);
                    console.log(`Net Cash from Bill (cashPaymentAmount - bill.change): ${netCashFromBill}`);
                    console.log(`Current Total Net Cash Sales: ${totalNetCashSales}`);
                    // ------------------------------------------

                    cursor.continue();
                } else {
                    // --- FINAL CALCULATION ---
                    const expectedCash = totalNetCashSales;

                    // ... (‡¶¨‡¶æ‡¶ï‡¶ø ‡¶ï‡ßã‡¶° ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§) ...
                    if (expectedCashDisplay) expectedCashDisplay.textContent = expectedCash.toFixed(2);
                    closingModal.dataset.expectedCash = expectedCash.toFixed(2);

                    if (closingStatusDiv) {
                        closingStatusDiv.className = 'info status-message';
                        closingStatusDiv.textContent = `‡¶∏‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶§ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂: ${expectedCash.toFixed(2)} ‡ß≥. ‡¶®‡ßã‡¶ü ‡¶ó‡¶£‡¶®‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`;
                    }

                    console.log(`[CLOSING] Final Expected Cash calculated: ${expectedCash.toFixed(2)} ‡ß≥`);
                }
            };

            request.onerror = (e) => {
                console.error("[CLOSING] ‡¶¨‡¶ø‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ", e.target.error);
                if (closingStatusDiv) {
                    closingStatusDiv.className = 'error status-message';
                    closingStatusDiv.textContent = "‚ùå ‡¶¨‡¶ø‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + e.target.error.message;
                }
            };
        }
        // --- üî• ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: window.closeSession (Final Message Fix) ---
        window.closeSession = function () {
            if (!currentSessionId) {
                alert("‚ùå ‡¶∏‡ßá‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
                return;
            }
            if (!db) return;

            // ‡ßß. ‡¶®‡ßã‡¶ü ‡¶ó‡¶£‡¶®‡¶æ ‡¶•‡ßá‡¶ï‡ßá Reported Cash ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ
            const reportedCash = calculateReportedCash();
            // Expected Cash ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡¶æ‡¶® ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ
            const expectedCash = parseFloat(expectedCashDisplay ? expectedCashDisplay.textContent : 0) || 0;
            const cashDifference = reportedCash - expectedCash;

            if (reportedCash < 0) {
                alert("‡¶ó‡¶£‡¶®‡¶æ‡¶ï‡ßÉ‡¶§ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶ó‡ßá‡¶ü‡¶ø‡¶≠ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá ‡¶®‡¶æ‡•§");
                return;
            }

            // ‡¶®‡ßã‡¶ü ‡¶ó‡¶£‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
            const notesCount = [];
            document.querySelectorAll('#cashCountTable input[type="number"]').forEach(input => {
                const value = parseFloat(input.dataset.value);
                const qty = parseInt(input.value) || 0;
                notesCount.push({ denomination: value, qty: qty, total: value * qty });
            });


            const transaction = db.transaction([BILLS_STORE_NAME], 'readonly');
            const billsStore = transaction.objectStore(BILLS_STORE_NAME);
            const sessionIndex = billsStore.index('sessionId');

            // ‡ß®. ‡¶¨‡¶ø‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßã‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ (‡¶è‡¶á ‡¶≤‡¶ú‡¶ø‡¶ï‡¶ü‡¶ø ‡¶∞‡ßá‡¶ñ‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶≤‡ßã, ‡¶Ø‡¶¶‡¶ø‡¶ì expectedCashDisplay ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡¶æ‡¶® ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá)
            let totalCashSales = 0;

            sessionIndex.openCursor(currentSessionId).onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const bill = cursor.value;
                    bill.payments.forEach(p => {
                        if (p.method === 'Cash') {
                            totalCashSales += p.amount;
                        }
                    });
                    cursor.continue();
                } else {

                    // ‡ß©. ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç Summary ‡¶§‡ßà‡¶∞‡¶ø
                    let closingSummary = {
                        sessionId: currentSessionId,
                        cashierId: currentCashierId,
                        reportTime: new Date().toISOString(),
                        expectedCash: expectedCash,
                        reportedCash: reportedCash,
                        difference: cashDifference,
                        status: cashDifference === 0 ? 'MATCHED' : (cashDifference > 0 ? 'OVER' : 'SHORT'),
                        notesCount: notesCount // ‡¶®‡ßã‡¶ü ‡¶ó‡¶£‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
                    };

                    // ‡ß™. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
                    saveCashClosingHistory(closingSummary);

                    // ‡ß´. ‡¶∏‡ßá‡¶∂‡¶®‡¶ü‡¶ø IndexedDB ‡¶è‡¶¨‡¶Ç localStorage ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ‡•§
                    updateSessionStatusInDB_CLOSE_SESSION(closingSummary);

                    // ‡ß¨. ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü
                    generateClosingReport(closingSummary);

                    // üî• ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶≤‡¶ú‡¶ø‡¶ï: ‡¶ö‡ßÇ‡¶°‡¶º‡¶æ‡¶®‡ßç‡¶§ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡ßá ‡¶ö‡¶ø‡¶π‡ßç‡¶®‡¶∏‡¶π ‡¶™‡¶æ‡¶∞‡ßç‡¶•‡¶ï‡ßç‡¶Ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                    const diffMessage = cashDifference === 0
                        ? cashDifference.toFixed(2)
                        : (cashDifference > 0
                            ? `+${cashDifference.toFixed(2)}`
                            : cashDifference.toFixed(2));


                    if (closingStatusDiv) {
                        closingStatusDiv.textContent = `‚úÖ ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç ‡¶∏‡¶´‡¶≤! ‡¶°‡¶ø‡¶´‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶∏: ${diffMessage} ‡¶ü‡¶æ‡¶ï‡¶æ‡•§ ‡¶∏‡ßá‡¶∂‡¶® ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§`;
                        closingStatusDiv.className = 'success status-message';
                    }

                    // ‡ß≠. Modal ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶∂‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
                    setTimeout(() => {
                        if (closingModal) closingModal.style.display = 'none';

                        // ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶∏‡ßá‡¶∂‡¶® ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
                        currentSessionId = null;
                        currentCashierId = null;

                        checkActiveSession();
                        showLoginPage(); // ‡¶ï‡ßç‡¶≤‡ßã‡¶ú‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶™‡¶∞ ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ü‡¶∏‡¶æ
                    }, 3000);
                }
            };

            transaction.onerror = (e) => {
                alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶®‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + e.target.error.message);
            };
        }

        function updateSessionStatusInDB_CLOSE_SESSION(closingSummary) {
            if (!db) return;
            const transaction = db.transaction([SESSIONS_STORE_NAME], 'readwrite');
            const store = transaction.objectStore(SESSIONS_STORE_NAME);

            const request = store.get(closingSummary.sessionId);

            request.onsuccess = (event) => {
                const session = event.target.result;
                if (session) {
                    session.status = 'CLOSED';
                    session.endTime = new Date().toISOString();
                    session.closingSummary = closingSummary;
                    store.put(session);
                }
            };

            // localStorage ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßá‡¶∂‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ
            localStorage.removeItem('activeSessionId');
            localStorage.removeItem('activeCashierId');
        }

        function saveCashClosingHistory(summary) {
            if (!db) return;
            const transaction = db.transaction([CLOSING_STORE_NAME], 'readwrite');
            const store = transaction.objectStore(CLOSING_STORE_NAME);
            const request = store.add(summary);
            request.onsuccess = () => {
                console.log(`Cash Closing Report for session ${summary.sessionId} saved.`);
            };
            request.onerror = (e) => {
                console.error("Cash Closing Report ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + e.target.error.message);
            };
        }

        // --- ‡ßØ. ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶¨‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï ---

        function generateClosingReport(summary) {
            // ‡¶®‡ßã‡¶ü ‡¶ó‡¶£‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ 
            const noteData = summary.notesCount ? summary.notesCount.filter(n => n.qty > 0) : [];

            let content = [
                { text: 'Cash Closing Report (Final)', style: 'header' },
                { text: `Session ID: ${summary.sessionId}`, style: 'subheader' },
                { text: `Cashier ID: ${summary.cashierId}`, margin: [0, 0, 0, 5] },
                { text: `Report Time: ${new Date(summary.reportTime).toLocaleString()}` },
                { canvas: [{ type: 'line', x1: 0, y1: 5, x2: 515, y2: 5, lineWidth: 1 }] },
                {
                    columns: [
                        { text: `Expected Cash (System): ${summary.expectedCash.toFixed(2)} ‡ß≥`, style: 'reportItem' },
                        { text: `Reported Cash (Count): ${summary.reportedCash.toFixed(2)} ‡ß≥`, style: 'reportItem' },
                        // ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü PDF-‡¶è ‡¶™‡¶æ‡¶∞‡ßç‡¶•‡¶ï‡ßç‡¶Ø ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶´‡¶∞‡ßç‡¶Æ‡¶æ‡¶ü‡¶ø‡¶Ç
                        { text: `Difference: ${summary.difference > 0 ? '+' : ''}${summary.difference.toFixed(2)} ‡ß≥`, style: summary.difference !== 0 ? 'difference' : 'reportItem' }
                    ],
                    margin: [0, 10, 0, 10]
                }
            ];

            // ‡¶®‡ßã‡¶ü ‡¶ó‡¶£‡¶®‡¶æ‡¶∞ ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
            if (noteData.length > 0) {
                content.push({ text: 'Note Count Details:', style: 'tableHeader', margin: [0, 10, 0, 5] });
                content.push({
                    table: {
                        headerRows: 1,
                        widths: ['*', 50, 80],
                        body: [
                            ['Denomination (‡ß≥)', 'Qty', 'Total (‡ß≥)']
                        ].concat(noteData.map(n => [
                            n.denomination.toFixed(2),
                            n.qty,
                            n.total.toFixed(2)
                        ]))
                    },
                    layout: 'lightHorizontalLines'
                });
            }

            const docDefinition = {
                content: content,
                styles: {
                    header: { fontSize: 22, bold: true, alignment: 'center', margin: [0, 0, 0, 10] },
                    subheader: { fontSize: 16, bold: true, margin: [0, 5, 0, 5] },
                    reportItem: { fontSize: 12, margin: [0, 2, 0, 2] },
                    difference: { fontSize: 12, bold: true, color: summary.difference !== 0 ? 'red' : 'black', margin: [0, 2, 0, 2] },
                    tableHeader: { bold: true, fontSize: 13, color: 'black' }
                }
            };

            pdfMake.createPdf(docDefinition).download(`Cash_Closing_Report_${summary.sessionId}.pdf`);
        }

        function printBill(bill) {
            const billItems = bill.items.map(item => [
                item.Name,
                item.Qty,
                item.SalePrice.toFixed(2),
                item.Total.toFixed(2)
            ]);

            const docDefinition = {
                content: [
                    { text: 'Customer Bill (Invoice)', style: 'header' },
                    { text: `Bill ID: ${bill.id}`, style: 'subheader' },
                    { text: `Date: ${new Date(bill.date).toLocaleString()}` },
                    { text: `Cashier: ${bill.cashierId}`, margin: [0, 0, 0, 10] },
                    { canvas: [{ type: 'line', x1: 0, y1: 5, x2: 515, y2: 5, lineWidth: 1 }] },

                    // Items Table
                    {
                        table: {
                            headerRows: 1,
                            widths: ['*', 40, 60, 60],
                            body: [
                                ['Item Name', 'Qty', 'Price', 'Total']
                            ].concat(billItems)
                        },
                        layout: 'lightHorizontalLines',
                        margin: [0, 10, 0, 10]
                    },

                    // Totals Section
                    { text: `Payable Amount: ${bill.payable.toFixed(2)} ‡ß≥`, alignment: 'right', margin: [0, 5, 0, 5], style: 'totalText' },
                    { text: `Received Amount: ${bill.received.toFixed(2)} ‡ß≥`, alignment: 'right', style: 'totalText' },
                    { text: `Change: ${bill.change.toFixed(2)} ‡ß≥`, alignment: 'right', style: 'totalTextBold' },

                    { canvas: [{ type: 'line', x1: 0, y1: 5, x2: 515, y2: 5, lineWidth: 0.5 }], margin: [0, 10, 0, 10] },

                    // Payments Breakdown
                    { text: 'Payments:', style: 'paymentHeader' },
                    ...bill.payments.map(p => ({ text: `${p.method}: ${p.amount.toFixed(2)} ‡ß≥`, alignment: 'right', style: 'paymentDetail' })),

                    { text: 'Thank you!', alignment: 'center', margin: [0, 20, 0, 0] }
                ],
                styles: {
                    header: { fontSize: 18, bold: true, alignment: 'center', margin: [0, 0, 0, 10] },
                    subheader: { fontSize: 14, bold: true, margin: [0, 5, 0, 5] },
                    totalText: { fontSize: 12 },
                    totalTextBold: { fontSize: 14, bold: true },
                    paymentHeader: { fontSize: 10, bold: true, margin: [0, 5, 0, 0] },
                    paymentDetail: { fontSize: 10 }
                }
            };
            pdfMake.createPdf(docDefinition).download(`Bill_${bill.id}.pdf`);
        }

        window.downloadInventoryExcel = async function () {
            if (allProducts.length === 0) {
                alert("‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                return;
            }

            if (!ExcelJS) {
                alert("ExcelJS ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§");
                return;
            }

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Current Inventory');

            // Exclude 'key' field from columns
            const columns = Object.keys(allProducts[0]).map(key => ({
                header: key,
                key: key,
                width: key.length > 20 ? 30 : key.length + 5
            }));
            const finalColumns = columns.filter(col => col.key !== 'key');

            worksheet.columns = finalColumns;

            allProducts.forEach(product => {
                const rowData = {};
                finalColumns.forEach(col => {
                    rowData[col.key] = product[col.key];
                });
                worksheet.addRow(rowData);
            });

            try {
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Inventory_Master_Stock_${new Date().toISOString().slice(0, 10)}.xlsx`;
                a.click();
                window.URL.revokeObjectURL(url);
                alert("‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
            } catch (error) {
                alert("‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
            }
        }

        window.downloadBillHistory = function (format) {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            if (!startDateInput || !endDateInput || !startDateInput.value || !endDateInput.value) {
                alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                return;
            }
            if (!db) return;

            const startISO = new Date(startDateInput.value).toISOString().slice(0, 10);
            const endISODate = new Date(endDateInput.value);
            endISODate.setDate(endISODate.getDate() + 1); // Get all bills up to the end of the selected end date
            const endISO = endISODate.toISOString().slice(0, 10);

            const transaction = db.transaction([BILLS_STORE_NAME], 'readonly');
            const store = transaction.objectStore(BILLS_STORE_NAME);
            const dateIndex = store.index('date');

            const range = IDBKeyRange.bound(startISO, endISO, false, true);

            const request = dateIndex.getAll(range);

            request.onsuccess = (event) => {
                const bills = event.target.result;
                if (bills.length === 0) {
                    alert(`Selected date range (${startDateInput.value} to ${endDateInput.value}) ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§`);
                    return;
                }

                const dateRange = `${startDateInput.value} to ${endDateInput.value}`;

                if (format === 'excel') {
                    generateBillHistoryExcel(bills, dateRange);
                } else if (format === 'pdf') {
                    generateBillHistoryPDF(bills, dateRange);
                }
            };
        }

        function generateBillHistoryExcel(bills, dateRange) {
            if (!ExcelJS) {
                alert("ExcelJS ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§");
                return;
            }

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Bill History');

            const columns = [
                { header: 'Bill ID', key: 'id', width: 20 },
                { header: 'Date/Time', key: 'date', width: 25 },
                { header: 'Cashier ID', key: 'cashierId', width: 12 },
                { header: 'Session ID', key: 'sessionId', width: 15 },
                { header: 'Total Payable', key: 'payable', width: 15 },
                { header: 'Payment Methods', key: 'payments', width: 30 },
                { header: 'Items Sold', key: 'items', width: 50 }
            ];
            worksheet.columns = columns;

            bills.forEach(bill => {
                const rowData = {
                    id: bill.id,
                    date: new Date(bill.date).toLocaleString(),
                    cashierId: bill.cashierId,
                    sessionId: bill.sessionId,
                    payable: bill.payable.toFixed(2),
                    payments: bill.payments.map(p => `${p.method}: ${p.amount.toFixed(2)}`).join(', '),
                    items: bill.items.map(item => `${item.Name} x${item.Qty}`).join(', ')
                };
                worksheet.addRow(rowData);
            });

            workbook.xlsx.writeBuffer().then(buffer => {
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Bill_History_Export_${dateRange.replace(/\s/g, '_')}.xlsx`;
                a.click();
                window.URL.revokeObjectURL(url);
                alert("‡¶¨‡¶ø‡¶≤ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
            }).catch(error => {
                alert("‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
            });
        }

        function generateBillHistoryPDF(bills, dateRange) {
            if (!pdfMake) {
                alert("PDFMake ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§");
                return;
            }

            const docDefinition = {
                content: [
                    { text: 'Bill History Report', style: 'header' },
                    { text: `Date Range: ${dateRange}`, style: 'subheader' },
                    {
                        table: {
                            headerRows: 1,
                            widths: [80, 100, 50, 60, '*'],
                            body: [
                                ['Bill ID', 'Date/Time', 'Cashier', 'Payable', 'Items']
                            ].concat(bills.map(bill => [
                                bill.id,
                                new Date(bill.date).toLocaleString(),
                                bill.cashierId,
                                bill.payable.toFixed(2),
                                bill.items.map(item => `${item.Name} x${item.Qty}`).join(', ')
                            ]))
                        },
                        layout: 'lightHorizontalLines'
                    }
                ],
                styles: {
                    header: { fontSize: 18, bold: true, alignment: 'center', margin: [0, 0, 0, 10] },
                    subheader: { fontSize: 15, bold: true, margin: [0, 10, 0, 5] },
                }
            };
            pdfMake.createPdf(docDefinition).download(`Bill_History_Export_${dateRange.replace(/\s/g, '_')}.pdf`);
        }

        window.downloadAllBills = function (format) {
            if (!db) return;

            const transaction = db.transaction([BILLS_STORE_NAME], 'readonly');
            const store = transaction.objectStore(BILLS_STORE_NAME);
            const request = store.getAll();

            request.onsuccess = (event) => {
                const bills = event.target.result;
                if (bills.length === 0) {
                    alert("‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ø‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§");
                    return;
                }

                if (format === 'excel') {
                    generateBillHistoryExcel(bills, 'All_Time');
                } else if (format === 'pdf') {
                    generateBillHistoryPDF(bills, 'All_Time');
                }
            };
        }

        window.searchAndPrintBill = function () {
            if (!billIdSearchInput || !db) return;
            const billNo = billIdSearchInput.value.trim();
            if (!billNo) {
                alert("‡¶¨‡¶ø‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®‡•§");
                return;
            }

            const transaction = db.transaction([BILLS_STORE_NAME], 'readonly');
            const store = transaction.objectStore(BILLS_STORE_NAME);
            const request = store.get(billNo);

            request.onsuccess = (event) => {
                const bill = event.target.result;
                if (bill) {
                    printBill(bill);
                } else {
                    alert(`‡¶¨‡¶ø‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ${billNo} ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§`);
                }
            };
            request.onerror = (e) => {
                alert("‡¶¨‡¶ø‡¶≤ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + e.target.error.message);
            };
        }

        // --- ‡ßß‡ß¶. ‡¶≠‡¶ø‡¶â ‡¶ü‡¶ó‡¶≤‡¶æ‡¶∞ ---

        function showSalesView() {
            const sales = document.getElementById('salesView');
            const admin = document.getElementById('adminView');

            if (sales) sales.style.display = 'block';
            if (admin) admin.style.display = 'none';

            // Sales view ‡¶è ‡¶è‡¶≤‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶ï‡¶∞‡¶æ
            if (searchInput) searchInput.focus();
        }

        function showAdminView() {
            const sales = document.getElementById('salesView');
            const admin = document.getElementById('adminView');

            if (sales) sales.style.display = 'none';
            if (admin) admin.style.display = 'block';
        }

        // --- ‡ßß‡ßß. ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ---
        window.onload = () => {
            openDatabaseAndLoadData();
            renderSalesTable();

            // *‡¶®‡¶§‡ßÅ‡¶®*: ‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡¶æ‡¶ü‡¶®-‡¶è‡¶∞ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó
            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.addEventListener('click', attemptLogin);
                // ‡¶è‡¶®‡ßç‡¶ü‡¶æ‡¶∞ (Enter) ‡¶™‡ßç‡¶∞‡ßá‡¶∏ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶≤‡¶ó‡¶á‡¶®
                document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        attemptLogin();
                    }
                });
            }

            // *‡¶®‡¶§‡ßÅ‡¶®*: ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶≠‡¶ø‡¶â ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';

            // showAdminView(); // ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶è‡¶ñ‡¶® ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á, ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá ‡¶ï‡¶≤ ‡¶π‡¶¨‡ßá
        }
    </script>

</body>

</html>